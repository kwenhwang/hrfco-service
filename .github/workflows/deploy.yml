name: Test GitHub Secrets

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Test Secrets (ì•ˆì „í•œ ë°©ë²•)
      env:
        HRFCO_API_KEY: ${{ secrets.HRFCO_API_KEY }}
      run: |
        echo "âœ… Secrets í…ŒìŠ¤íŠ¸ ì‹œì‘"
        echo "API í‚¤ ê¸¸ì´: ${#HRFCO_API_KEY}"
        echo "API í‚¤ ì‹œì‘: ${HRFCO_API_KEY:0:8}..."
        echo "API í‚¤ ë: ...${HRFCO_API_KEY: -4}"
        
        # Pythonìœ¼ë¡œ Config í…ŒìŠ¤íŠ¸
        python -c "
        from src.hrfco_service.config import Config
        print(f'âœ… Config ë¡œë“œ ì„±ê³µ')
        print(f'API í‚¤ ê¸¸ì´: {len(Config.API_KEY)}')
        print(f'API í‚¤ ì‹œì‘: {Config.API_KEY[:8]}...')
        print(f'API í‚¤ ë: ...{Config.API_KEY[-4:]}')
        "
        
        # ì‹¤ì œ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)
        echo " ì‹¤ì œ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸..."
        python -c "
        import asyncio
        import httpx
        import os
        
        async def test_api():
            api_key = os.getenv('HRFCO_API_KEY')
            url = f'http://api.hrfco.go.kr/{api_key}/waterlevel/info.json'
            
            async with httpx.AsyncClient() as client:
                response = await client.get(url)
                print(f'API ì‘ë‹µ ìƒíƒœ: {response.status_code}')
                if response.status_code == 200:
                    print('âœ… API í˜¸ì¶œ ì„±ê³µ!')
                else:
                    print(f'âš ï¸ API í˜¸ì¶œ ì‹¤íŒ¨: {response.status_code}')
        
        asyncio.run(test_api())
        "
    
    - name: Test MCP Server
      env:
        HRFCO_API_KEY: ${{ secrets.HRFCO_API_KEY }}
      run: |
        echo "ğŸ¤– MCP ì„œë²„ í…ŒìŠ¤íŠ¸..."
        timeout 30s python mcp_server.py &
        sleep 5
        
        # MCP ì„œë²„ í…ŒìŠ¤íŠ¸
        python test_mcp_direct.py || echo "MCP í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        
        echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ!" 