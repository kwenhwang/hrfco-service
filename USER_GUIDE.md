# 사용자 가이드 - API 키 없이 HRFCO 데이터 사용하기

## 🎯 개요

이 가이드는 **API 키를 발급받지 않아도** HRFCO 수문 데이터를 사용할 수 있는 방법을 설명합니다.

## 📋 사용자 유형별 가이드

### 1. 일반 사용자 (API 키 없이 사용)

#### Glama에서 사용하기
1. **Glama 접속**: https://glama.ai
2. **MCP 서버**: https://glama.ai/mcp/servers/@kwenhwang/hrfco-service
3. **서버 활성화**: 클릭하여 활성화
4. **질문하기**: 자연어로 수문 데이터 요청

**예시 질문:**
```
"부산 지역의 수위 관측소 정보를 알려줘"
"영천댐의 현재 방류량을 확인해줘"
"최근 강수량 현황을 보여줘"
"홍수 위험이 있는 지역이 있나요?"
"하동군 대석교의 위험 수위 상태를 분석해줘"
"부산 지역의 수위 관측소 현황을 요약해줘"
"하동군 대석교와 주변 강우량 관측소의 종합 분석을 해줘"
```

#### Claude Desktop에서 사용하기
1. **Claude Desktop 설치**: https://claude.ai
2. **MCP 설정**: `claude_desktop_config.json` 파일 생성
3. **서버 연결**: 설정 파일에 MCP 서버 정보 추가
4. **질문하기**: 자연어로 수문 데이터 요청

**설정 파일 예시:**
```json
{
  "mcpServers": {
    "hrfco-flood-control": {
      "command": "python",
      "args": ["mcp_server.py"],
      "env": {
        "PYTHONPATH": "src"
      }
    }
  }
}
```

#### HTTP API 사용하기
서버가 배포된 경우 HTTP API로 직접 호출 가능:

```bash
# 관측소 정보 조회
curl "http://localhost:8000/observatories?hydro_type=waterlevel"

# 수문 데이터 조회
curl "http://localhost:8000/hydro?hydro_type=dam&time_type=10M&obs_code=1001210"

# 서버 상태 확인
curl "http://localhost:8000/health"
```

### 2. 개발자/운영자 (API 키 필요)

#### 로컬 개발 환경
```bash
# 환경변수 설정
export HRFCO_API_KEY="your-api-key"

# 서버 실행
python -m src.hrfco_service.http_server

# MCP 서버 실행
python mcp_server.py

# 향상된 기능 테스트
python test_mcp_enhanced.py
```

#### Docker 배포
```bash
# 환경변수와 함께 실행
docker run -p 8000:8000 -e HRFCO_API_KEY="your-api-key" hrfco-service
```

#### Kubernetes 배포
```yaml
# deployment.yaml
env:
- name: HRFCO_API_KEY
  valueFrom:
    secretKeyRef:
      name: hrfco-secrets
      key: api-key
```

### 3. Docker로 로컬 실행 (API 키 없이)
사용자는 API 키 없이 미리 빌드된 Docker 이미지를 실행할 수 있습니다:

```bash
# 미리 빌드된 이미지 실행 (API 키는 이미 포함됨)
docker pull kwenhwang/hrfco-service:latest
docker run -p 8080:8080 kwenhwang/hrfco-service:latest

# 또는 직접 빌드 (개발자용)
docker build --build-arg HRFCO_API_KEY="your-api-key" -t hrfco-service .
docker run -p 8080:8080 hrfco-service
```

#### Claude Desktop 설정
```json
{
  "mcpServers": {
    "hrfco": {
      "command": "docker",
      "args": ["run", "--rm", "-p", "8080:8080", "kwenhwang/hrfco-service:latest"]
    }
  }
}
```

#### Glama에서 사용
1. https://glama.ai 접속
2. https://glama.ai/mcp/servers/@kwenhwang/hrfco-service 접속
3. 서버 활성화
4. "부산 수위 정보 알려줘" 질문

## 🔧 사용 가능한 도구

### 기본 MCP 서버 도구
| 도구명 | 설명 | 매개변수 |
|--------|------|----------|
| `get_observatory_info` | 관측소 정보 조회 | `hydro_type` (waterlevel/rainfall/dam/bo) |
| `get_hydro_data` | 수문 데이터 조회 | `hydro_type`, `time_type`, `obs_code` |
| `get_server_health` | 서버 상태 확인 | 없음 |
| `get_server_config` | 서버 설정 확인 | 없음 |

### 🆕 향상된 분석 도구
| 도구명 | 설명 | 매개변수 |
|--------|------|----------|
| `analyze_water_level_with_thresholds` | 수위 관측소 위험 수위 분석 | `obs_code`, `time_type`, `count` |
| `get_comprehensive_hydro_analysis` | 수위+강우량 종합 분석 | `water_level_obs`, `rainfall_obs`, `time_type`, `count` |
| `get_alert_status_summary` | 지역별 위험 수위 상태 요약 | `region_name`, `hydro_type` |

### HTTP API 엔드포인트
| 엔드포인트 | 설명 | 매개변수 |
|------------|------|----------|
| `GET /observatories` | 관측소 정보 | `hydro_type`, `document_type` |
| `GET /hydro` | 수문 데이터 | `hydro_type`, `time_type`, `obs_code` |
| `GET /health` | 서버 상태 | 없음 |
| `GET /config` | 서버 설정 | 없음 |

## 📊 데이터 타입

### 지원하는 수문 데이터
- **waterlevel**: 수위 데이터
- **rainfall**: 강수량 데이터  
- **dam**: 댐 데이터
- **bo**: 보 데이터

### 지원하는 시간 단위
- **10M**: 10분
- **1H**: 1시간
- **1D**: 1일

## 🚀 빠른 시작

### 1. Glama에서 바로 사용
1. https://glama.ai 접속
2. https://glama.ai/mcp/servers/@kwenhwang/hrfco-service 접속
3. 서버 활성화
4. "부산 수위 정보 알려줘" 질문

### 2. Claude에서 사용
1. Claude Desktop 설치
2. MCP 설정 파일 생성
3. 서버 연결
4. 자연어로 질문

### 3. HTTP API 사용
```bash
# 서버가 실행 중인 경우
curl "http://localhost:8000/hydro?hydro_type=waterlevel&time_type=10M&obs_code=2022678"
```

## 🆕 새로운 기능 사용법

### 📊 데이터 양 최적화

Claude 사용량을 최적화하기 위해 데이터 양을 지능적으로 조절합니다:

**기본 분석 (적은 데이터):**
- 기본 데이터 개수: 24개 (기존 48개에서 감소)
- 기본 시간 범위: 48시간 (기존 72시간에서 감소)
- 최근 데이터: 최근 5개만 포함
- 상세 분석: 기본적으로 비활성화

**상세 분석 (많은 데이터):**
- 상세 분석 요청 시: 최소 72개 데이터, 최소 168시간(7일)
- 최근 데이터: 최근 10개 포함
- 통계 정보: 상세 통계 및 상관관계 분석 포함
- 상관관계 분석: 강우량-수위 상관관계 분석 포함

**사용 예시:**
```
"하동군 대석교 수위 분석해줘"  # 기본 분석 (적은 데이터)
"하동군 대석교 수위 상세 분석해줘"  # 상세 분석 (많은 데이터)
```

### 📊 데이터 가용성 개선

기존의 "데이터가 제한적"이라는 문제를 해결했습니다:

**개선 사항:**
- **시간 범위 확장**: 48시간 → 최대 720시간(30일)까지 조회
- **자동 날짜 계산**: 요청 시간에 따라 자동으로 시작/종료 날짜 설정
- **데이터 밀도 정보**: 실제 사용 가능한 데이터 개수 표시
- **유연한 파라미터**: `hours` 파라미터로 조회 범위 조정

**사용 예시:**
```
"하동군 대석교의 최근 7일간 수위 변화를 분석해줘"
```

**응답에서 확인할 수 있는 정보:**
- `total_available`: 실제 사용 가능한 데이터 개수
- `hours_requested`: 요청한 시간 범위
- `data_count_requested`: 요청한 데이터 개수

### 1. 위험 수위 기준 활용

**질문 예시:**
```
"하동군 대석교의 위험 수위 상태를 분석해줘"
"부산 대동낙동강교의 경보 기준까지 얼마나 남았나요?"
"영천댐의 현재 위험도를 평가해줘"
```

**응답 특징:**
- 관심, 주의보, 경보, 심각 단계별 위험 수위 기준 자동 적용
- 현재 수위와 각 단계별 여유/초과 거리 계산
- 변화 추세 분석 (상승/하락, 변화율)

### 2. 종합 수문 분석

**질문 예시:**
```
"하동군 대석교와 주변 강우량 관측소의 종합 분석을 해줘"
"부산 지역의 수위와 강우량 상관관계를 분석해줘"
"영천댐과 주변 강우량 관측소의 종합 분석을 해줘"
```

**응답 특징:**
- 관측소 간 거리 자동 계산
- 강우량-수위 상관관계 분석
- 시간별 매칭 데이터 제공
- 변화율 및 최대값 분석

### 3. 지역별 위험 수위 상태 요약

**질문 예시:**
```
"부산 지역의 수위 관측소 현황을 요약해줘"
"전국의 위험 수위 상태를 확인해줘"
"경상남도 지역의 수위 관측소 상태를 알려줘"
```

**응답 특징:**
- 지역별 관측소 자동 검색
- 단계별 관측소 개수 통계
- 현재 상태 요약 제공
- 위험도별 분류

### 4. 수계 종합 분석

**질문 예시:**
```
"하동군 대석교 주변 20km 내의 모든 수문 시설을 종합 분석해줘"
"부산 지역의 수계별 종합 분석을 해줘"
"영천댐 주변의 수계 분석을 해줘"
```

**응답 특징:**
- 거리 기반 근접 시설 검색 (최대 20km)
- 수위, 강우량, 댐, 보 통합 분석
- 시설별 통계 및 위험도 평가
- 수계별 분포 통계 제공

### 5. WAMIS API 수계 시설 검색

**질문 예시:**
```
"낙동강 수계의 모든 수위 관측소를 찾아줘"
"한강 수계의 한국수자원공사 댐들을 검색해줘"
"섬진강 수계의 강우량 관측소 현황을 알려줘"
```

**응답 특징:**
- 수계별 시설 검색 (한강, 낙동강, 금강, 섬진강, 영산강, 제주도)
- 시설 타입별 필터링 (수위, 강우량, 기상, 댐)
- 관할기관별 필터링 (환경부, 한국수자원공사, 한국농어촌공사, 기상청, 한국수력원자력)
- 운영상태별 필터링 (운영중, 폐쇄)
- 시설 개수 통계 제공

### 6. 통합 온톨로지 기반 분석

**질문 예시:**
```
"하동군 대석교의 상류/하류 관측소들을 찾아줘"
"낙동강 수계의 모든 관측소 현황을 알려줘"
"4009670 관측소의 수계 관계를 분석해줘"
"한강 수계의 수위 관측소만 검색해줘"
```

**응답 특징:**
- 3개 API 정보 통합 (홍수통제소, WAMIS, 기상청)
- 표준유역코드 기반 상류/하류 관계 분석
- 수계별 관측소 분포 및 통계
- 관측소 타입별 필터링 (수위, 강우량, 댐, 기상)
- 데이터 소스별 필터링 (hrfco, wamis, weather)
- 정확한 수계 관계 파악으로 상류/하류 데이터만 제공

## 📝 실제 사용 예시

### 예시 1: 위험 수위 분석
```
사용자: "하동군 대석교의 위험 수위 상태를 분석해줘"

Claude: "하동군 대석교의 위험 수위 상태를 분석해드리겠습니다.

📊 현재 상황:
- 현재 수위: 4.25m
- 관심 기준(2.2m): 2.05m 초과 ⚠️
- 주의보 기준(4.0m): 0.25m 초과 ⚠️
- 경보 기준(5.0m): 0.75m 여유 ✅
- 심각 기준(5.9m): 1.65m 여유 ✅

📈 변화 추세:
- 최근 6시간 동안 상승 추세
- 시간당 평균 0.15m 상승
- 지속적인 모니터링 필요

�� 권고사항:
현재 주의보 단계에 있으며, 지속적인 상승 추세를 보이고 있습니다. 
경보 기준까지 0.75m 여유가 있지만, 현재 추세를 고려하면 주의가 필요합니다."
```

### 예시 2: 종합 분석
```
사용자: "하동군 대석교와 주변 강우량 관측소의 종합 분석을 해줘"

Claude: "하동군 대석교와 하동군(읍내리) 강우량 관측소의 종합 분석 결과입니다.

📍 관측소 정보:
- 수위 관측소: 하동군 대석교 (4009670)
- 강우량 관측소: 하동군(읍내리) (40094090)
- 관측소 간 거리: 0.95km (매우 근접)

📊 위험 수위 상태:
- 현재 수위: 4.25m
- 주의보 기준(4.0m): 0.25m 초과
- 경보 기준(5.0m): 0.75m 여유

🌧️ 강우량-수위 상관관계:
- 최근 48시간 총 강우량: 272mm
- 최대 시간당 강우량: 39mm
- 수위 변화: 1.25m → 4.25m (3.0m 상승)
- 강우와 수위 변화의 즉시 반응 확인

⚠️ 위험도 평가:
현재 주의보 단계에 있으며, 지속적인 강우 시 경보 단계로 상승할 가능성이 있습니다.
관측소 간 거리가 매우 근접하여 강우 데이터의 신뢰성이 높습니다."
```

### 예시 3: 지역 현황 요약
```
사용자: "부산 지역의 수위 관측소 현황을 요약해줘"

Claude: "부산 지역의 수위 관측소 현황을 요약해드리겠습니다.

📊 전체 현황:
- 총 관측소: 15개
- 정상 상태: 10개 ✅
- 관심 단계: 3개 ⚠️
- 주의보 단계: 2개 ⚠️
- 경보 단계: 0개
- 심각 단계: 0개

📍 주요 관측소 현황:
- 부산 대동낙동강교: 3.42m (정상)
- 부산 강서구: 2.8m (관심)
- 부산 사하구: 4.1m (주의보)

💡 종합 평가:
부산 지역은 전반적으로 안정적인 상태입니다. 
주의보 단계인 관측소들이 있지만, 경보나 심각 단계는 없어 지역적 위험도는 낮습니다.
지속적인 모니터링이 권장됩니다."
```

## ❓ 자주 묻는 질문

**Q: API 키가 없어도 정말 사용할 수 있나요?**
A: 네! Glama나 Claude에서 MCP 서버를 통해 사용하면 API 키 입력 없이도 데이터를 조회할 수 있습니다.

**Q: 개인정보나 API 키가 노출되나요?**
A: 아니요. API 키는 서버 내부에서만 사용되며, 사용자에게는 노출되지 않습니다.

**Q: 어떤 데이터를 조회할 수 있나요?**
A: 수위, 강수량, 댐, 보 데이터를 실시간으로 조회할 수 있습니다. 위험 수위 기준과 종합 분석도 가능합니다.

**Q: 사용량 제한이 있나요?**
A: HRFCO API 정책에 따라 제한이 있을 수 있습니다. 과도한 사용은 피해주세요.

**Q: 새로운 기능들은 어떻게 사용하나요?**
A: 자연어로 질문하시면 됩니다. 예: "하동군 대석교의 위험 수위 상태를 분석해줘"

**Q: 관측소 간 거리는 어떻게 계산되나요?**
A: Haversine 공식을 사용하여 두 관측소의 위도/경도 좌표로부터 거리를 계산합니다.

## 🆘 문제 해결

### 서버 연결 실패
- 인터넷 연결 확인
- 서버 상태 확인: `GET /health`
- 방화벽 설정 확인

### 데이터 조회 실패
- 관측소 코드 확인
- 시간 단위 확인 (10M, 1H, 1D)
- API 서버 상태 확인

### MCP 서버 오류
- Python 환경 확인
- 의존성 설치 확인: `pip install -r requirements.txt`
- 로그 확인

### 새로운 기능 오류
- 관측소 코드가 올바른지 확인
- 위험 수위 기준이 설정된 관측소인지 확인
- 네트워크 연결 상태 확인

**hours 파라미터 오류:**
```
"HRFCOAPI.fetch_observatory_data() got an unexpected keyword argument 'hours'"
```
→ 최신 버전으로 업데이트하세요. 이 오류는 수정되었습니다.

**데이터 제한 문제:**
```
"데이터가 제한적입니다"
```
→ `hours` 파라미터를 사용하여 더 많은 시간 범위를 요청하세요.

## 📞 지원

- **이슈 리포트**: GitHub Issues
- **문서**: README.md 참조
- **예제**: `test_mcp_enhanced.py` 참조

---

**즐거운 수문 데이터 활용하세요! 🌊** 